registrationModule.controller("cotizacionAutorizacionController",function(t,o,a,n,e,i,c,r,d,u){var l=[],s=[],f=a.get("cita"),h=a.get("cotizacion"),g=a.get("work"),b=a.get("taller");t.idTrabajoOrden=a.get("objTrabajo"),t.estado=a.get("estado"),t.setInterval=5e3,t.message="Obteniendo información ...",t.chat=[],t.descripcion=a.get("desc");var m=2,z=0;t.init=function(){var a=n.path();t.cargaFicha(),t.cargaChat(),t.getCotizacionByTrabajo(),t.Detalle(h,b),t.cargaEvidencias(),t.cargaDocs(h),t.cargaDatosCliente(f),o.showChat=1},t.cargaChat=function(){t.promise=i.getChat(f).then(function(o){t.chat=o.data},function(t){})},t.cargaFicha=function(){i.getFichaTecnica(f).then(function(o){o.data.length>0&&(t.unidadInfo=o.data[0],a.set("objFicha",t.unidadInfo))},function(t){})},t.EnviarComentario=function(o){i.putMessage(3,o,f).then(function(o){t.algo=o.data,t.cargaChat()},function(t){})},t.getCotizacionByTrabajo=function(){t.promise=i.getCotizacionByTrabajo(f).then(function(o){t.cotizacionesByTrabajo=o.data},function(t){})},t.Autorizar=function(t){i.putCotizacionAprobacion(h,1,t).then(function(o){o.data.length>0&&(d.postMail(h,1,2,t),e.success("Cotización Autorizada correctamente"),location.href="/trabajo")},function(t){e.error("No se pudo autorizar la cotización, inténtelo más tarde")})},$("#myTabs a").click(function(t){t.preventDefault(),$(this).tab("show")}),t.lookUpTrabajo=function(o){t.promise=c.getTrabajo(o).then(function(o){o.data.length>0?(t.existsTrabajo=!0,e.success("Trabajo cargado"),c.getCotizacion(o.data[0].idTrabajo).then(function(t){t.data.length>0?c.getCotizacionDetalle(o.data[0].idTrabajo).then(function(a){c.getPaquete(o.data[0].idTrabajo).then(function(n){j(o.data,t.data,a.data,n.data)})}):e.info("No se encontraron cotizaciones")},function(t){e("Error al obtener las cotizaciones")})):(e.info("No se encontraron datos del trabajo"),t.trabajo=[])},function(t){e.error("Error al obtener datos del trabajo")})};var j=function(o,a,n,e){t.trabajo=[],o.forEach(function(o){t.trabajo.push({trabajo:o}),t.trabajo[0].trabajo.cotizacion=a,t.trabajo[0].trabajo.cotizacion.forEach(function(o,a){l=Enumerable.From(n).Where(function(t){return t.idCotizacion==o.idCotizacion}).Select(function(t){return t}).ToArray(),t.trabajo[0].trabajo.cotizacion[a].cotizacionDetalle=l,t.trabajo[0].trabajo.cotizacion[a].cotizacionDetalle.forEach(function(n,i){s=Enumerable.From(e).Where(function(t){return t.idCotizacion==o.idCotizacion&&1==n.idTipoElemento}).Select(function(t){return t}).ToArray(),s.length>0&&(t.trabajo[0].trabajo.cotizacion[a].cotizacionDetalle[i].paquete=s)})})})};$(function(){$("body").on("click",".CX button",function(){"+"==$(this).text()?$(this).text("-"):$(this).text("+"),$(this).closest("tr").next("tr").toggle()})}),t.cargaEvidencias=function(){i.getEvidenciasByCotizacion(h).then(function(o){o.data.length>0?t.slides=o.data:t.alerta=1},function(t){})},t.Rechazar=function(t){i.putCotizacionRechazo(h,1,t).then(function(o){o.data.length>0&&(d.postMail(h,1,3,t),e.success("Cotización Rechazada correctamente"),location.href="/trabajo")},function(t){})},t.nuevaCotizacion=function(){a.set("cita",a.get("objTrabajo")),location.href="/cotizacionNueva"},t.Adjuntar=function(){$("#modal").appendTo("body").modal("show")},t.Editar=function(){var t={idCotizacion:h,idTaller:b,idTrabajo:g};a.set("objEditCotizacion",t),location.href="/cotizacionNueva"},t.cargarArchivos=function(){formArchivos=document.getElementById("uploader"),contentForm=formArchivos.contentWindow||formArchivos.contentDocument,contentForm.document&&(btnSubmit=contentForm.document.getElementById("submit2")),elements=contentForm.document.getElementById("uploadForm").elements,idTrabajoEdit=contentForm.document.getElementById("idTrabajo"),idCotizacionEdit=contentForm.document.getElementById("idCotizacion"),idTrabajoEdit.value=g,idCotizacionEdit.value=h,z=h;for(var o=0;o<elements.length;o++)elements[o].value.lastIndexOf(".")>0&&(t.nombreArchivo=elements[o].value,t.tipoArchivo=p(t.nombreArchivo),t.idTipoArchivo=v(t.tipoArchivo),r.insertEvidencia(m,t.idTipoArchivo,1,z,t.nombreArchivo).then(function(t){e.success("Evidencia Guardada Correctamente")},function(t){e.error("Error")}));btnSubmit.click(),t.cargaEvidencias(),t.cargaDocs(z),$("#modal").modal("hide")};var p=function(o){t.file=o;var a=t.file.substring(t.file.length-4,t.file.length);return a},v=function(t){return".pdf"==t||".doc"==t||".xls"==t||".docx"==t||".xlsx"==t||".PDF"==t||".DOC"==t||".XLS"==t||".DOCX"==t||".XLSX"==t||".ppt"==t||".PPT"==t?type=1:".jpg"==t||".png"==t||".gif"==t||".bmp"==t||".JPG"==t||".PNG"==t||".GIF"==t||".BMP"==t?type=2:".mp4"==t&&(type=3),type};t.cargaDocs=function(o){t.promise=i.getDocs(o).then(function(o){t.docs=o.data},function(t){})},t.FinishSave=function(){e.success("Guardando Archivos")},t.Detalle=function(o,a){u.getDetail(o,a).then(function(o){if(o.data.length>0){t.total=0,t.articulos=o.data;for(var a=0;a<o.data.length;a++)t.total+=o.data[a].precio*o.data[a].cantidad;e.success("Datos cargados.")}else e.info("No se pudo obtener el detalle de esta cotización.")},function(t){e.info("No se pudo obtener el detalle de esta cotización.")})},t.Evidencias=function(){location.href="/cotizacionevidencias"},t.cargaDatosCliente=function(o){i.getDatosCliente(o).then(function(o){o.data.length>0&&(t.ClienteData=o.data[0])},function(t){e.error("No se pudo obtener los datos del cliente, inténtelo más tarde")})}});