registrationModule.controller("cotizacionController",function(i,t,o,a,e,n){i.arrayItem=[],i.arrayCambios=[];var r="",c=0,d=0,m=null,u=0,l="",s="",f="",b=0,p=0,C=0,E=2;i.editar=0,i.total=0,i.importe=0,i.idUsuario=1,i.message="Buscando...",i.numEconomico="",i.modeloMarca="",i.trabajo="",i.idCita="",i.init=function(){$(".collapse-link").click(function(){var i=$(this).closest("div.ibox"),t=$(this).find("i"),o=i.find("div.ibox-content");o.slideToggle(200),t.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"),i.toggleClass("").toggleClass("border-bottom"),setTimeout(function(){i.resize(),i.find("[id^=map-]").resize()},50)}),exist=!1,null!=a.get("objEditCotizacion")?(i.editCotizacion=a.get("objEditCotizacion"),g(),i.editar=1,i.estado=2,i.editarCotizacion(i.editCotizacion.idCotizacion,i.editCotizacion.idTaller)):(i.citaDatos=a.get("cita"),i.estado=1,j(),F(i.citaDatos.idCita),a.remove("objEditCotizacion"),a.remove("objFicha")),null!=a.get("objCita")&&(i.objCita=a.get("objCita"))},i.buscarPieza=function(t){""==t||null==t?o.info("Ingrese un dato para búsqueda"):(p=null==i.objCita?i.citaDatos.idTaller:i.objCita.idTaller,i.promise=e.buscarPieza(p,t).then(function(t){i.listaPiezas=t.data,setTimeout(function(){$(".dataTableItem").DataTable({dom:'<"html5buttons"B>lTfgitp',buttons:[{extend:"copy"},{extend:"csv"},{extend:"excel",title:"ExampleFile"},{extend:"pdf",title:"ExampleFile"},{extend:"print",customize:function(i){$(i.document.body).addClass("white-bg"),$(i.document.body).css("font-size","10px"),$(i.document.body).find("table").addClass("compact").css("font-size","inherit")}}]})},2e3)},function(i){o.error("Error")})),t=""},i.cotizacion=function(t){0!=i.arrayItem.length&&1==z(t)?(i.arrayItem.forEach(function(o,a){o.idItem==t.idItem&&o.idTipoElemento==t.idTipoElemento&&(i.arrayItem[a].cantidad=o.cantidad+1,i.arrayItem[a].importe=i.arrayItem[a].cantidad*i.arrayItem[a].precio,i.importe=i.arrayItem[a].importe,i.total=I())}),exist=!1):(i.arrayItem.push({numeroPartida:t.numeroPartida,idItem:t.idItem,numeroParte:t.numeroParte,item:t.item,precio:t.precio,cantidad:1,importe:1*t.precio,idTipoElemento:t.idTipoElemento,idEstatus:9}),1==i.editar&&i.arrayCambios.push({numeroPartida:t.numeroPartida,idItem:t.idItem,numeroParte:t.numeroParte,item:t.item,precio:t.precio,cantidad:1,importe:1*t.precio,idTipoElemento:t.idTipoElemento,idEstatus:9}),h(),i.total=I(),exist=!1)};var z=function(t){return i.arrayItem.forEach(function(i){i.idItem==t.idItem&&i.idTipoElemento==t.idTipoElemento&&(exist=!0)}),exist},I=function(){var t=0;return i.arrayItem.forEach(function(i){t+=i.importe}),v(t)},y=function(){var t=0;return i.arrayItem.forEach(function(i){t+=i.importe}),v(t)},h=function(){var t=0;i.arrayItem.forEach(function(i){i.importe=parseFloat(i.precio)*parseFloat(i.cantidad)})},v=function(i){return"$"+i.toFixed(2).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")};i.quitarPieza=function(t){i.arrayItem.forEach(function(o,a){o.idItem==t.idItem&&o.idTipoElemento==t.idTipoElemento&&(i.arrayItem[a].cantidad>1?(i.arrayItem[a].cantidad=o.cantidad-1,i.arrayItem[a].importe=i.arrayItem[a].cantidad*i.arrayItem[a].precio,i.total=I(),1==i.editar&&(i.arrayCambios[a].cantidad=i.arrayItem[a].cantidad)):(i.arrayItem.splice(a,1),i.total=I(),i.importe=0,1==i.editar&&(i.arrayCambios[a].idEstatus=10)))})},i.enviarAutorizacion=function(t){0==i.arrayItem.length?o.info("Debe seleccionar items para la cotización"):C=null==i.objCita?i.citaDatos.idUnidad:i.objCita.idUnidad,e.insertCotizacionMaestro(i.citaDatos.idCita,i.idUsuario,t,C).then(function(t){o.success("Guardando Cotización Maestro"),i.idCotizacion=t.data[0].idCotizacion,i.idTrabajo=t.data[0].idTrabajo,i.arrayItem.forEach(function(t,a){e.insertCotizacionDetalle(i.idCotizacion,t.idTipoElemento,t.idItem,t.precio,t.cantidad,t.idEstatus).then(function(i){o.success("Guardando Cotización Detalle")},function(i){o.error("Error")})}),T(i.idCotizacion,i.idTrabajo),n.postMail(i.idCotizacion,i.citaDatos.idTaller,1,""),a.remove("objCita"),a.remove("cita"),location.href="/cotizacionConsulta"},function(i){o.error("Error")})},i.FinishSave=function(){o.success("Guardando Archivos"),location.href="/cotizacionConsulta"},i.editarCotizacion=function(t,a){e.editarCotizacion(i.editCotizacion.idCotizacion,i.editCotizacion.idTaller).then(function(t){i.arrayItem=t.data,i.arrayCambios=i.arrayItem.slice(),i.observaciones=t.data[0].observaciones,i.total=y(),i.importe=h()},function(i){o.error("Error")})},i.updateCotizacion=function(t){var r="",c="",d="",m="";i.arrayCambios.forEach(function(a,n){e.updateCotizacion(i.editCotizacion.idCotizacion,a.idTipoElemento,a.idItem,a.precio,a.cantidad,t,a.idEstatus).then(function(i){o.success("Cotización Actualizada ")},function(i){o.error("Error")})}),T(i.editCotizacion.idCotizacion,i.editCotizacion.idTrabajo),n.postMail(i.editCotizacion.idCotizacion,i.editCotizacion.idTaller,1,""),a.remove("objEditCotizacion"),a.remove("objFicha"),location.href="/cotizacionConsulta"};var T=function(i,t){formArchivos=document.getElementById("uploader"),contentForm=formArchivos.contentWindow||formArchivos.contentDocument,contentForm.document&&(btnSubmit=contentForm.document.getElementById("submit2")),elements=contentForm.document.getElementById("uploadForm").elements,idTrabajoEdit=contentForm.document.getElementById("idTrabajo"),idCotizacionEdit=contentForm.document.getElementById("idCotizacion"),idTipoEvidencia=contentForm.document.getElementById("idTipoEvidencia"),idUsuario=contentForm.document.getElementById("idUsuario"),idTrabajoEdit.value=t,idCotizacionEdit.value=i,idTipoEvidencia.value=2,idUsuario.value=1,btnSubmit.click()},g=function(){null!=a.get("objFicha")&&(i.objFicha=a.get("objFicha"),i.numEconomico=i.objFicha.numEconomico,i.modeloMarca=i.objFicha.marca+"  "+i.objFicha.modelo,i.trabajo=i.objFicha.trabajo)},j=function(){null!=a.get("cita")&&(i.numEconomico=i.citaDatos.numEconomico,i.modeloMarca=i.citaDatos.modeloMarca,i.trabajo=i.citaDatos.trabajo)},F=function(t){e.busquedaServicioDetalle(t).then(function(t){i.arrayItem=t.data,i.arrayCambios=i.arrayItem.slice(),i.importe=h(),i.total=y()},function(i){o.error("Error")})}});